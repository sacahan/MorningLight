name: Daily Weight Reminder

on:
  schedule:
    # 台灣時間 (UTC+8) 06:00 - 12:00
    - cron: '0 22 * * *'  # 06:00 (前一天)
    - cron: '0 23 * * *'  # 07:00 (前一天)
    - cron: '0 0 * * *'   # 08:00
    - cron: '0 1 * * *'   # 09:00
    - cron: '0 2 * * *'   # 10:00
    - cron: '0 3 * * *'   # 11:00
    - cron: '0 4 * * *'   # 12:00
  workflow_dispatch:
    inputs:
      hour:
        description: 'Target hour (6-12)'
        required: true
        default: '10'

jobs:
  trigger-reminder:
    runs-on: ubuntu-latest
    steps:
      - name: Calculate Taiwan hour from UTC
        id: calc
        run: |
          # 取得輸入的小時，如果沒有則根據當前 UTC 時間計算
          HOUR="${{ github.event.inputs.hour }}"
          if [ -z "$HOUR" ]; then
            UTC_HOUR=$(date -u +%H)
            # UTC+8
            HOUR=$(( (UTC_HOUR + 8) % 24 ))
          fi
          echo "Target Hour: $HOUR"
          echo "hour=$HOUR" >> $GITHUB_OUTPUT
      
      - name: Call Supabase Edge Function
        run: |
          curl -X POST "${{ secrets.SUPABASE_URL }}/functions/v1/send-weight-reminder?hour=${{ steps.calc.outputs.hour }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{}'
